–ü–æ—è—Å–Ω—é –ø–æ–¥—Ä–æ–±–Ω–æ, —á—Ç–æ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏ –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ–±—ã —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª –≤—Å—é —Å—Ö–µ–º—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–∞–π–ª—ã.

üß† 1. Dev –±–∞–∑–∞ (db:)

–î–∞ ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (dev).
–û–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤–æ—Ç —ç—Ç–∏–º –±–ª–æ–∫–æ–º:

  db:
    image: postgres:15
    container_name: saasbot_db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-saasdb}
      POSTGRES_USER: ${POSTGRES_USER:-saasuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-saaspass}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

‚öôÔ∏è –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:

postgres_data ‚Äî –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ –¥–∏—Å–∫–µ.
–î–∞–∂–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—à—å ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.

5432:5432 ‚Äî –±–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –∏–∑–≤–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, IDE, pgAdmin).

.env –∑–∞–≥—Ä—É–∂–∞–µ—Ç POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD.

–≠—Ç–æ –±–∞–∑–∞, –∫—É–¥–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–æ—Ç –∏ –≤–æ—Ä–∫–µ—Ä –≤ –¥–µ–≤–µ.

üß™ 2. –¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ (test_db:)

–î–∞ ‚Äî –≤—Ç–æ—Ä–∞—è –±–∞–∑–∞, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
–û–Ω–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–æ–º –∂–µ Docker network,
–Ω–æ –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π volume.

  test_db:
    image: postgres:15
    container_name: saasbot_test_db
    env_file:
      - .env.test
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data

‚öôÔ∏è –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:

tmpfs ‚Äî –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–∫–µ –∏ —Å—Ç–∏—Ä–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
‚Üí –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤.

–ü–æ—Ä—Ç 5433 –≤–Ω–µ—à–Ω–µ, –Ω–æ –≤ —Å–µ—Ç–∏ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∏–º–µ–Ω–∏ test_db:5432.

–§–∞–π–ª .env.test –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–∞–º –¥—Ä—É–≥–æ–π DATABASE_URL.

üí° –í–∞–∂–Ω–æ:
–ö–æ–≥–¥–∞ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è, pytest –±–µ—Ä—ë—Ç DATABASE_URL –∏–∑ .env.test,
–∏ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ test_db.
–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ç–µ—Å—Ç—ã –±—Ä–∞–ª–∏ .env, –∞ –Ω–µ .env.test.

ü§ñ 3. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
üü¢ bot
  bot:
    build: .
    depends_on:
      db:
        condition: service_healthy


‚Äî –≠—Ç–æ —Å–∞–º FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–±–æ—Ç), –∫–æ—Ç–æ—Ä–æ–µ –æ–±—â–∞–µ—Ç—Å—è —Å dev-–±–∞–∑–æ–π (db).

üß± worker
  worker:
    build: .
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started


‚Äî –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å.
–û–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–µ—Ç:

–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (—á–µ—Ä–µ–∑ Redis),

—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Å MinIO,

–≤—ã–ø–æ–ª–Ω—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å–∞–ª.

–û–±—ã—á–Ω–æ –≤–æ—Ä–∫–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—É –∂–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –Ω–æ –±–µ–∑ API ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ—Ä–∫–µ—Ä-–ø—Ä–æ—Ü–µ—Å—Å—ã.

üíæ 4. Redis

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –±—Ä–æ–∫–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ—á–µ—Ä–µ–¥–µ–π.
FastAPI-–±–æ—Ç –º–æ–∂–µ—Ç –∫–ª–∞—Å—Ç—å —Ç—É–¥–∞ –∑–∞–¥–∞—á–∏, –∞ worker –∏—Ö –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç.
–¢–∞–∫–∂–µ Redis –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è:

–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

rate limiting (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤)

—Ö—Ä–∞–Ω–µ–Ω–∏—è user-—Å–µ—Å—Å–∏–π

‚òÅÔ∏è 5. MinIO

–≠—Ç–æ self-hosted –∞–Ω–∞–ª–æ–≥ Amazon S3.
–¢—ã –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Ç—á—ë—Ç–æ–≤ –∏ —Ç.–¥.).
–í —Ç–≤–æ—ë–º –∫–æ–¥–µ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:

import boto3
s3 = boto3.client(
    "s3",
    endpoint_url="http://minio:9000",
    aws_access_key_id="minioadmin",
    aws_secret_access_key="minioadmin",
)

üß© –í –∏—Ç–æ–≥–µ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —Å—Ö–µ–º–∞ —Ç–∞–∫–∞—è:
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  Telegram    ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ  bot (FastAPI)‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
             ‚ñº                        ‚ñº
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ PostgreSQL ‚îÇ<‚îÄ‚îÄvol‚îÄ‚îÄ‚îÄ>‚îÇ Redis        ‚îÇ
       ‚îÇ saasdb     ‚îÇ          ‚îÇ queue/cache  ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   MinIO    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


–ê –ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö:

pytest ‚îÄ‚îÄ> test_db (saasdb_test, –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∞–∑–∞ –≤ RAM)
