### 2. **Папка `scripts/`**
   - Храним утилитарные SQL / Python скрипты.

   Сейчас:
   - `check_fk.sql` → Проверка целостности данных. сканирует все таблицы и ищет записи, у которых поля created_by или updated_by ссылаются на несуществующего пользователя. Запускайте его в любой момент. Если он возвращает пустую таблицу, значит, в базе данных нет битых ссылок, и всё в порядке.
   - `fix_fk.sql` → Автоматическое исправление битых ссылок. Запускайте его только после того, как check_fk.sql покажет, что есть проблемы.
   - `check_models_vs_db.py`. Синхронизация кода и базы данных. показывает, если какая-то таблица существует в коде, но отсутствует в БД, и наоборот. Запускайте его после каждой миграции или после добавления новой модели, чтобы убедиться, что ваши код и база данных идеально соответствуют друг другу.




   ## Документация проверок целостности данных

### Общее описание

Данная документация описывает систему проверок внешних ключей в базе данных проекта. Основная цель — обеспечение целостности данных и выявление "битых" ссылок между таблицами.

### Расположение файлов

* **Основной скрипт проверок**: `scripts/check_fk.sql`
* **Документация**: `docs/database/fk_checks.md`
* **Результаты проверок** сохраняются в лог-файлы

### Структура проверок

Проверки организованы по принципу поиска "битых" ссылок между таблицами. Каждая проверка возвращает список проблемных мест, где нарушена целостность данных.

### Пример SQL-скрипта

```sql
-- Проверка целостности внешних ключей
WITH broken AS (
    -- Trials
    SELECT 'trials.created_by' AS field, COUNT(*) AS broken_count
    FROM trials t LEFT JOIN users u ON t.created_by = u.id
    WHERE t.created_by IS NOT NULL AND u.id IS NULL
    UNION ALL

    -- Projects
    SELECT 'projects.created_by', COUNT(*)
    FROM projects p LEFT JOIN users u ON p.created_by = u.id
    WHERE p.created_by IS NOT NULL AND u.id IS NULL
    UNION ALL

    -- Files
    SELECT 'files.uploader_id', COUNT(*)
    FROM files f LEFT JOIN users u ON f.uploader_id = u.id
    WHERE f.uploader_id IS NOT NULL AND u.id IS NULL
)
SELECT * FROM broken WHERE broken_count > 0;
```

### Инструкция по использованию

Для запуска проверок выполните:
```bash
make check-fk
```

### Структура документации

#### 1. Описание таблицы

**Таблица**: files

* **Назначение**: хранение информации о загруженных файлах
* **Основные поля**:
  * `id` — уникальный идентификатор
  * `uploader_id` — связь с пользователем
  * `task_id` — связь с задачей
  * `company_id` — связь с компанией

#### 2. Проверяемые связи

* **Связь с пользователями**:
  ```sql
  SELECT 'files.uploader_id' AS field, COUNT(*) AS broken_count
  FROM files f LEFT JOIN users u ON f.uploader_id = u.id
  WHERE f.uploader_id IS NOT NULL AND u.id IS NULL
  ```

* **Связь с задачами**:
  ```sql
  SELECT 'files.task_id' AS field, COUNT(*) AS broken_count
  FROM files f LEFT JOIN tasks t ON f.task_id = t.id
  WHERE f.task_id IS NOT NULL AND t.id IS NULL
  ```

#### 3. Ожидаемый результат

* Пустой результат означает отсутствие проблем
* Наличие строк указывает на проблемные связи

### Рекомендации по поддержке

* **Регулярное обновление** документации при изменении структуры БД
* **Автоматизация** проверок в CI/CD
* **Уведомления** при обнаружении проблем
* **Логирование** результатов проверок

### Шаблон для новых проверок

При добавлении новой таблицы:
1. Создайте раздел в документации
2. Опишите все внешние ключи
3. Добавьте SQL-запросы для проверки
4. Включите проверки в общий скрипт

### Интеграция с CI/CD

Рекомендуется:
* Добавить запуск проверок в pipeline
* Настроить оповещения при обнаружении проблем
* Сохранить результаты проверок в артефактах сборки

---

### Связанные документы

* [Структура базы данных](docs/database/schema.md)
* [Модели данных](models/README.md)
* [Скрипты проверок](scripts/README.md)
