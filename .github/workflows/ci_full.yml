name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # -------------------------------
  # 1. Lint / Security
  # -------------------------------
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements*.txt') }}

      - name: ðŸ“‘ Install linters and security tools
        run: |
          pip install -r requirements-lint.txt
          pip install bandit safety

      - name: ðŸ” Run linters
        run: |
          ruff check .
          black --check .
          flake8 .
          bandit -r . || true
          safety scan || true


  # -------------------------------
  # 2. Unit Tests (local Postgres)
  # -------------------------------
  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: saasuser
          POSTGRES_PASSWORD: saaspass
          POSTGRES_DB: saasdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U saasuser -d saasdb_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ðŸ“‘ Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install coverage pytest-cov
      
      - name: ðŸ”§ Prepare test environment
        run: |
          echo "ðŸ§© Preparing .env.test for pytest..."
          cp .env.ci .env.test
          sed -i 's/@postgres:5432/@localhost:5432/g' .env.test
          echo "âœ… Final .env.test:"
          cat .env.test

      - name: ðŸ’¤ Wait for PostgreSQL
        run: |
          until pg_isready -U saasuser -d saasdb_test -h localhost -p 5432; do
            echo "â³ Waiting for PostgreSQL..."
            sleep 2
          done
          echo "âœ… PostgreSQL is ready!"


      - name: ðŸ›  Apply migrations
        run: |
          set -o allexport
          source .env
          set +o allexport
          echo "ðŸ” Checking DB connection..."
          psql "$DATABASE_URL" -c "SELECT version();" || echo "âš ï¸ Cannot connect to DB"
          alembic upgrade head

      - name: ðŸ§ª Run unit tests
        run: |
          set -o allexport
          source .env
          set +o allexport
          pytest -vv -m "not smoke" \
            --cov=saas_bot \
            --cov-report=xml \
            --cov-report=html \
            --log-cli-level=DEBUG


  # -------------------------------
  # 3. Build Docker image
  # -------------------------------
  build-image:
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ“¦ Build Docker image
        run: |
          echo "Building docker image..."
          docker build -t saasbot:ci .
          docker images saasbot:ci

      - name: ðŸ§ª Run container sanity check
        run: |
          echo "Testing container startup..."
          docker run --rm saasbot:ci python -c "print('âœ… Container runs Python OK')"



  # -------------------------------
  # 4. Smoke Tests (compose + built image)
  # -------------------------------
  smoke-tests:
    runs-on: ubuntu-latest
    needs: build-image
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ³ Ensure docker-compose available
        run: docker compose version || docker --version

      - name: âš™ï¸ Load CI env file
        run: |
          if [ -f .env.ci ]; then
            echo "Loading .env.ci"
            while read -r line; do
              if [[ ! "$line" =~ ^# && "$line" =~ = ]]; then
                echo "$line" >> $GITHUB_ENV
              fi
            done < .env.ci
          fi

      - name: ðŸ”§ Prepare .env for docker-compose
        run: |
          echo "ðŸ§© Copying .env.ci â†’ .env (for docker compose)..."
          cp .env.ci .env
          echo "âœ… .env file prepared:"
          head -n 10 .env

      - name: ðŸš€ Start test environment (db, redis, minio, test_db)
        run: |
          docker compose up -d db test_db redis minio
          sleep 8
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: ðŸ›  Apply migrations
        run: docker compose run --rm bot alembic upgrade head

      - name: ðŸ§ª Run smoke tests with reports
        run: |
          mkdir -p test-reports
          docker compose run --rm bot pytest -vv tests/smoke \
            --log-cli-level=INFO \
            --junitxml=test-reports/junit.xml \
            --html=test-reports/report.html \
            --self-contained-html

      - name: ðŸ“¦ Upload smoke test logs and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-reports/
          if-no-files-found: ignore
