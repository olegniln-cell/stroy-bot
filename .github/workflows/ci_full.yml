name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # -------------------------------
  # 1. Lint / Security
  # -------------------------------
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: üì¶ Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements*.txt') }}

      - name: üìë Install linters and security tools
        run: |
          pip install -r requirements-lint.txt
          pip install bandit safety

      - name: üîç Run linters
        run: |
          ruff check .
          black --check .
          flake8 .
          bandit -r . || true
          safety scan || true


  # -------------------------------
  # 2. Unit Tests (local Postgres)
  # -------------------------------
  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: saasuser
          POSTGRES_PASSWORD: saaspass
          POSTGRES_DB: saasdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U saasuser -d saasdb_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: üìë Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install coverage pytest-cov

      - name: ‚öôÔ∏è Prepare environment for CI
        run: |
          echo "üå± Preparing .env from .env.ci..."
          export POSTGRES_HOST=localhost
          export POSTGRES_PORT=5432
          export POSTGRES_USER=saasuser
          export POSTGRES_PASSWORD=saaspass
          export POSTGRES_DB=saasdb_test
          # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ env.ci –≤ –Ω–æ–≤—ã–π .env
          envsubst < .env.ci > .env
          echo "‚úÖ Final .env content:"
          cat .env

      - name: üí§ Wait for PostgreSQL
        run: |
          until pg_isready -U saasuser -d saasdb_test -h localhost -p 5432; do
            echo "‚è≥ Waiting for PostgreSQL..."
            sleep 2
          done
          echo "‚úÖ PostgreSQL is ready!"

      - name: üõ† Apply migrations
        run: |
          set -o allexport
          source .env
          set +o allexport
          echo "üîç Checking DB connection..."
          psql "$DATABASE_URL" -c "SELECT version();" || echo "‚ö†Ô∏è Cannot connect to DB"
          alembic upgrade head

      - name: üß™ Run unit tests
        run: |
          set -o allexport
          source .env
          set +o allexport
          pytest -vv -m "not smoke" \
            --cov=saas_bot \
            --cov-report=xml \
            --cov-report=html \
            --log-cli-level=DEBUG


  # -------------------------------
  # 3. Build Docker image
  # -------------------------------
  build-image:
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 20

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: üì¶ Build Docker image
        run: |
          echo "Building docker image..."
          docker build -t saasbot:ci .
          docker images saasbot:ci

      - name: üß™ Run container sanity check
        run: |
          echo "Testing container startup..."
          docker run --rm saasbot:ci python -c "print('‚úÖ Container runs Python OK')"



  # -------------------------------
  # 4. Smoke Tests (compose + built image)
  # -------------------------------
  smoke-tests:
    runs-on: ubuntu-latest
    needs: build-image
    timeout-minutes: 30

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üê≥ Ensure docker-compose available
        run: docker compose version || docker --version

      - name: ‚öôÔ∏è Load CI env file
        run: |
          if [ -f .env.ci ]; then
            echo "Loading .env.ci"
            while read -r line; do
              if [[ ! "$line" =~ ^# && "$line" =~ = ]]; then
                echo "$line" >> $GITHUB_ENV
              fi
            done < .env.ci
          fi

      - name: üîß Prepare .env for docker-compose
        run: |
          echo "üß© Copying .env.ci ‚Üí .env (for docker compose)..."
          cp .env.ci .env
          echo "‚úÖ .env file prepared:"
          head -n 10 .env

      - name: üöÄ Start test environment (db, redis, minio, test_db)
        run: |
          docker compose up -d db test_db redis minio
          sleep 8
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: üõ† Apply migrations
        run: docker compose run --rm bot alembic upgrade head

      - name: üß™ Run smoke tests with reports
        run: |
          mkdir -p test-reports
          docker compose run --rm bot pytest -vv tests/smoke \
            --log-cli-level=INFO \
            --junitxml=test-reports/junit.xml \
            --html=test-reports/report.html \
            --self-contained-html

      - name: üì¶ Upload smoke test logs and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-reports/
          if-no-files-found: ignore
