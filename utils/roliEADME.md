

–ó–ê–ü–†–û–°
—Å–µ–π—á–∞—Å –≤ –±–∞–∑–µ —Ç–∞–∫ user_role | user user_role | admin user_role | manager –≤ –∫–æ–¥–µ —Ç–∞–∫ WORKER = "worker" # —Ä–∞–±–æ—á–∏–π FOREMAN = "foreman" # –±—Ä–∏–≥–∞–¥–∏—Ä MANAGER = "manager" # —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å ADMIN = "admin" # –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∞ –≤ –±–∞–∑–µ user_role | user –¥—É–º–∞—é —á—Ç–æ. –Ω–µ –Ω—É–∂–µ–Ω!!! –¢—ã —á—Ç–æ –¥—É–º–∞–µ—à—å? –∞ –Ω—É–∂–µ–Ω - WORKER = "worker" # —Ä–∞–±–æ—á–∏–π FOREMAN = "foreman" # –±—Ä–∏–≥–∞–¥–∏—Ä –∫–∞–∫ —ç—Ç–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å ?–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–ª—å—è–∑–∞ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –º–æ–∂–µ—Ç —Ç–æ–≥–¥–∞ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–Ω–µ—Å—Ç–∏ –≤ —Ç—É–º–∏–≥—Ä–∞—É–∏—é –≥–¥–µ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ –±—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞ –±—ã–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è? –≤–æ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≥–æ–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ https://gist.github.com/FinoSag/42b6daa0dd8f7c71d4ed5b1503f9d7ab –æ—Ç–∫—Ä—ã–ª–∏—Å—å? –∫–∞–∫ –±—ã—Ç—å –≤ —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å—ã–Ω–π –ª—É—á—à–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–º –≤ –±—É–¥—É—é—â–µ–º —á—Ç–æ –±—ã –Ω–µ–±—ã–ª–æ –æ—à–∏–±–æ–∫ –∏ –≤ –±—É–¥—É—é—â–µ–º –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ –Ω–µ –ø–æ–Ω–∏–º–∞—é –ø–æ—á–µ–º—É —Ç—É–∞ —Å–ª–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω—ã–µ —Ä–æ–ª–∏ –∏–ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ò –°—Ä–∞–≤–Ω–∏ —Å –∫–æ–¥ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–µ—Ç–∞–ª—å–Ω–æ –∫–∞–∫ —Å–µ–π—á–∞—Å —É—Å—Ç—Ä–æ–µ–Ω—ã —Ä–æ–ª–∏ –¥–∞–π –æ—Ç—á–µ—Ç –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ ? –∫–∞–∫–∏–µ —Ä–æ–ª–∏ —Å–µ–π—á–∞—Å –≤ –∫–æ–¥–µ? –∫–∞–∫–∞—è –ª–æ–≥–∏–∫–∞? –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö? –≤ –º–æ–¥–µ–ª—è—Ö? –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö? https://gist.github.com/FinoSag/ef17d38898e6bd734c6ffac84e1b5365 –æ—Ç–∫—Ä—ã–ª—Å—è —Ñ–∞–π–ª? –ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—â–µ–π –∑–∞–¥–∞—á–∏? 5. CI: –¥–æ–±–∞–≤–∏—Ç—å job migrations_apply_on_clean_db: ‚ó¶ –ø–æ–¥–Ω–∏–º–∞—Ç—å —á–∏—Å—Ç—ã–π Postgres (–≤ CI job), ‚ó¶ alembic upgrade head, ‚ó¶ –∑–∞–ø—É—Å–∫ check_models_vs_db.py, ‚ó¶ –∑–∞–ø—É—Å–∫ smoke-integration tests (create company ‚Üí trial). ‚ó¶ –ï—Å–ª–∏ alembic revision --autogenerate –¥–∞—ë—Ç diff ‚Äî –ø–∞–¥–∞—Ç—å CI. 6. Acceptance criteria (—Ñ–∞–∑–∞ 1): alembic upgrade head –Ω–∞ —á–∏—Å—Ç–æ–π –ë–î –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫; –≤—Å–µ smoke tests –ø—Ä–æ—Ö–æ–¥—è—Ç. –ù–µ —Ä–µ—à–∏–≤ –∑–∞–¥–∞—á—É —Å —Ä–æ–ª—è–º–∏ –∏–ª–∏ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å —Å —Ä–æ–ª—è–º–∏ —á—Ç–æ –±—ã –±—ã–ª–æ –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ


–¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–ª–æ–≤–∏–ª –∫–ª—é—á–µ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É ‚Äî —É –≤–∞—Å —Å–µ–π—á–∞—Å **—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –º–µ–∂–¥—É –∫–æ–¥–æ–º –∏ –ë–î –ø–æ —Ä–æ–ª—è–º**, –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ—à–∏—Ç—å, —Ç–æ CI, –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É–¥—É—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ª–æ–º–∞—Ç—å—Å—è.

üìä **–†–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏:**

* **–í –ë–î (`user_role`)**: `user`, `admin`, `manager`.
* **–í –∫–æ–¥–µ (`UserRole`)**: `worker`, `foreman`, `manager`, `admin`.
* **–ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ:** –≤ –∫–æ–¥–µ –Ω–µ—Ç `user`, –∞ –≤ –ë–î –Ω–µ—Ç `worker` –∏ `foreman`.
* **–õ–æ–≥–∏–∫–∞ –≤ –∫–æ–¥–µ:** —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ middleware —Ä–µ–∞–ª—å–Ω–æ –∂–¥—É—Ç `WORKER`, `FOREMAN`, `MANAGER`, `ADMIN`.

üëâ –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç–µ–∫—É—â–∏–π `enum` –≤ –±–∞–∑–µ *–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –∫–æ–¥–∞*.
–ï—Å–ª–∏ —Ç—ã —Å–µ–π—á–∞—Å "–ø–æ–¥–≥–æ–Ω–∏—à—å –∫–æ–¥ –ø–æ–¥ –ë–î" (—Ç.–µ. –¥–æ–±–∞–≤–∏—à—å `USER` –æ–±—Ä–∞—Ç–Ω–æ –∏ –≤—ã–∫–∏–Ω–µ—à—å `WORKER/FOREMAN`), —Ç–æ:

* –º–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç —á–∏—Å—Ç—ã–º–∏,
* CI –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å,
* **–Ω–æ –ª–æ–≥–∏–∫–∞ —Ä–æ–ª–µ–π –≤ –∫–æ–¥–µ —Å–ª–æ–º–∞–µ—Ç—Å—è**, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (`if user.role == UserRole.WORKER`) –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

---

### üîë –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é):

1. **–ù–µ –º–µ–Ω—è—Ç—å –∫–æ–¥ –ø–æ–¥ –±–∞–∑—É**, –∞ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî –ø—Ä–∏–≤–µ—Å—Ç–∏ –±–∞–∑—É –∫ –∫–æ–¥—É.
   –¢–æ –µ—Å—Ç—å –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ç—ã—Ä–µ —Ä–æ–ª–∏:

   * `worker`
   * `foreman`
   * `manager`
   * `admin`
     –∏ —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—É—é `user`.

2. **–°–¥–µ–ª–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –∑–∞–º–µ–Ω—É enum (—á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π —Ç–∏–ø)**:

   * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `enum` —Å–æ –≤—Å–µ–º–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏.
   * –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ª–æ–Ω–∫—É.
   * –ü–µ—Ä–µ–º–∞–ø–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (`user ‚Üí worker`).
   * –î—Ä–æ–ø–Ω—É—Ç—å —Å—Ç–∞—Ä—ã–π enum –∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–º.

3. **–í –±—É–¥—É—â–µ–º** ‚Äî –¥–µ—Ä–∂–∞—Ç—å —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ä–æ–ª–∏ –≤ –∫–æ–¥–µ –∏ –≤ –±–∞–∑–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.

---

### üìå –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å `user` –∏–∑ enum?

* PostgreSQL –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä–æ–ø–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ enum, –µ—Å–ª–∏ –æ–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
* –î–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Äî –ø—Ä—è–º–æ–≥–æ `ALTER TYPE DROP VALUE` —Ç–æ–∂–µ –Ω–µ—Ç (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ "–Ω–æ–≤—ã–π —Ç–∏–ø").

---

### ‚öôÔ∏è –ö–∞–∫ –±—ã—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏?

* –°—É–¥—è –ø–æ gist, —É —Ç–µ–±—è —Ü–µ–ø–æ—á–∫–∞ —É–∂–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
* –õ—É—á—à–µ **—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ–≤–µ—Ä—Ö**, –∞ –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ (–∏–Ω–∞—á–µ —Å–ª–æ–º–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π —É –≤—Å–µ—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤).
* –í –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞–º–µ–Ω—É —Ä–æ–ª–µ–π –∫–∞–∫ —è –æ–ø–∏—Å–∞–ª –≤—ã—à–µ.

---

### üö¶ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–∫–æ—Ä–æ—Ç–∫–æ):

1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `xxxx_update_user_role_enum.py`.
2. –í –Ω–µ–π:

   * —Å–æ–∑–¥–∞—Ç—å `user_role_new (worker, foreman, manager, admin)`
   * –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `role_new`
   * –ø–µ—Ä–µ–º–∞–ø–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (`user ‚Üí worker`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞–≤–∏—Ç—å)
   * —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É, —Å—Ç–∞—Ä—ã–π —Ç–∏–ø
   * –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É –∏ –Ω–æ–≤—ã–π enum –≤ —Å—Ç–∞—Ä—ã–µ –∏–º–µ–Ω–∞.
3. –ü—Ä–æ–≥–Ω–∞—Ç—å `alembic upgrade head` –Ω–∞ —á–∏—Å—Ç–æ–π –±–∞–∑–µ.
4. –ü—Ä–æ–≥–Ω–∞—Ç—å `check_models_vs_db.py`.
5. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `alembic revision --autogenerate` –Ω–µ –¥–∞—ë—Ç diff.
6. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç, —Å–≤–µ—Ä—è—é—â–∏–π —Ä–æ–ª–∏ –∏–∑ –ë–î –∏ –∏–∑ Python enum.

---

üî• –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

* —Ç—ã –Ω–µ —Ç–µ—Ä—è–µ—à—å –¥–∞–Ω–Ω—ã–µ,
* –∫–æ–¥ –∏ –±–∞–∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã,
* –≤ –±—É–¥—É—â–µ–º CI –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ä–æ–ª–∏ –Ω–µ —Ä–∞–∑—ä–µ–¥—É—Ç—Å—è.

---

–•–æ—á–µ—à—å, —è –ø—Ä—è–º–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é —Ç–µ–±–µ –≥–æ—Ç–æ–≤—É—é Alembic-–º–∏–≥—Ä–∞—Ü–∏—é (–∫–æ–¥ upgrade/downgrade), –∫–æ—Ç–æ—Ä—É—é —Ç—ã –º–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?




–í–ù–ï–°–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø
–ù–∏–∂–µ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è **¬´–±–æ–∫—Å-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è¬ª** (—à–∞–≥-–∑–∞-—à–∞–≥) —Å –≥–æ—Ç–æ–≤—ã–º –∫–æ–¥–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ —Ç–µ—Å—Ç–æ–º. –û–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç Postgres `user_role (user, admin, manager)` ‚Üí –Ω–∞–±–æ—Ä —Ä–æ–ª–µ–π –≤ –∫–æ–¥–µ `worker, foreman, manager, admin`, –Ω–µ –ª–æ–º–∞—è –¥–∞–Ω–Ω—ã—Ö, –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π —á–∏—Å—Ç–æ–π.

> ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞–π –±—ç–∫–∞–ø –ë–î –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –∫–æ–ø–∏–∏ (restore/test). –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ç–∫–∞–ø–∞ –µ—Å—Ç—å –≤–Ω–∏–∑—É.

---

# 1) –ö—Ä–∞—Ç–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π enum `user_role_new` —Å –Ω—É–∂–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (`worker`, `foreman`, `manager`, `admin`).
2. –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É `users` –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ª–æ–Ω–∫—É `role_new` —Å —Ç–∏–ø–æ–º `user_role_new`.
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–º–∞–ø–∏—Ç—å) –¥–∞–Ω–Ω—ã–µ: `user -> worker`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º.
4. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É `role`.
5. –ü–æ–º–µ–Ω—è—Ç—å –∏–º–µ–Ω–∞ —Ç–∏–ø–æ–≤/–∫–æ–ª–æ–Ω–æ–∫: `user_role_new` ‚Üí `user_role`, `role_new` ‚Üí `role`.
6. –ü—Ä–æ–≥–Ω–∞—Ç—å `alembic upgrade head`, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—ë (enum –≤ –ë–î, check\_models, autogen, smoke tests).
7. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é enum –≤ –∫–æ–¥–µ –∏ –ë–î.

---

# 2) Alembic-–º–∏–≥—Ä–∞—Ü–∏—è ‚Äî –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä `migrations/versions/20250913_update_user_role_enum.py` (–Ω–∞–∑–æ–≤–∏ –ø–æ —Å–≤–æ–µ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É). –í—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥, **–∑–∞–º–µ–Ω–∏** `down_revision` –Ω–∞ —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é (`34b46aedc031` —É —Ç–µ–±—è) –∏ –ø—Ä–æ—Å—Ç–∞–≤—å `revision` —É–Ω–∏–∫–∞–ª—å–Ω–æ (uuid/—Ç–æ–∫–µ–Ω).

```python
# migrations/versions/20250913_update_user_role_enum.py
"""Replace user_role enum: add worker, foreman; map 'user' -> 'worker' safely.

Revision ID: 20250913_update_user_role_enum
Revises: 34b46aedc031
Create Date: 2025-09-13
"""
from alembic import op
import sqlalchemy as sa

revision = "20250913_update_user_role_enum"
down_revision = "34b46aedc031"
branch_labels = None
depends_on = None

def upgrade():
    # 1) Create new enum type
    op.execute("CREATE TYPE user_role_new AS ENUM ('worker','foreman','manager','admin')")

    # 2) Add new nullable column using the new enum
    op.add_column(
        "users",
        sa.Column(
            "role_new",
            sa.Enum("worker","foreman","manager","admin", name="user_role_new"),
            nullable=True
        )
    )

    # 3) Map/transfer existing values: user -> worker; keep admin/manager as-is
    op.execute("""
        UPDATE users
        SET role_new = CASE role::text
            WHEN 'user' THEN 'worker'
            WHEN 'admin' THEN 'admin'
            WHEN 'manager' THEN 'manager'
            ELSE 'worker'
        END::user_role_new
    """)

    # 4) (Optional) ensure values populated (you may add checks/logging here)
    # 5) Drop old column 'role'
    op.drop_column('users', 'role')

    # 6) Remove old type and rename new type to original name
    op.execute("DROP TYPE IF EXISTS user_role")
    op.execute("ALTER TYPE user_role_new RENAME TO user_role")

    # 7) Rename column role_new -> role
    op.alter_column('users', 'role_new', new_column_name='role')

    # 8) (Optional) set NOT NULL if desired:
    # op.alter_column('users', 'role', nullable=False)


def downgrade():
    # Reverse: create old type and map back worker/foreman -> user
    op.execute("CREATE TYPE user_role_old AS ENUM ('user','admin','manager')")

    op.add_column(
        'users',
        sa.Column(
            'role_old',
            sa.Enum('user','admin','manager', name='user_role_old'),
            nullable=True
        )
    )

    op.execute("""
        UPDATE users
        SET role_old = CASE role::text
            WHEN 'worker' THEN 'user'
            WHEN 'foreman' THEN 'user'
            WHEN 'admin' THEN 'admin'
            WHEN 'manager' THEN 'manager'
            ELSE 'user'
        END::user_role_old
    """)

    op.drop_column('users', 'role')

    # drop current type and restore name
    op.execute("DROP TYPE IF EXISTS user_role")
    op.execute("ALTER TYPE user_role_old RENAME TO user_role")

    op.alter_column('users', 'role_old', new_column_name='role')
```

**–ü–æ—è—Å–Ω–µ–Ω–∏—è:**

* –ú—ã —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ç–∏–ø `user_role_new`, –¥–æ–±–∞–≤–ª—è–µ–º `role_new`.
* –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `role::text` ‚Üí new enum (–ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ).
* –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É –∏ —Å—Ç–∞—Ä—ã–π —Ç–∏–ø, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º `user_role_new` -> `user_role`.
* `downgrade()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ (–º–∞–ø–ø–∏—Ä—É–µ—Ç `worker/foreman` ‚Üí `user`) ‚Äî —ç—Ç–æ –±–∞–∑–æ–≤—ã–π rollback.

---

# 3) –ö–æ–º–∞–Ω–¥—ã ‚Äî –ø–æ—à–∞–≥–æ–≤–æ (–ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Docker Compose)

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º ‚Äî —Å–¥–µ–ª–∞–π –±—ç–∫–∞–ø:

```bash
# —Å–æ–∑–¥–∞—ë–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ (–Ω–∞ —Ö–æ—Å—Ç–µ)
mkdir -p ./backups

# –¥–∞–º–ø –ë–î –≤ —Ñ–∞–π–ª –Ω–∞ —Ö–æ—Å—Ç–µ (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å -T –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
docker-compose exec -T db pg_dump -U saasuser saasdb > ./backups/saasdb_before_enum.sql
```

–ü–æ—Ç–æ–º –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ `bot` –µ—Å—Ç—å alembic –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω DATABASE\_URL):

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤ git), –∑–∞—Ç–µ–º:
git add migrations/versions/20250913_update_user_role_enum.py
git commit -m "Add migration: update user_role enum (add worker, foreman)"

# 2. –ù–∞ –∫–æ–ø–∏–∏/–ª–æ–∫–∞–ª—å–Ω–æ–π dev –ë–î –∑–∞–ø—É—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é:
docker-compose exec bot alembic upgrade head
```

–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```bash
# –ø–æ–∫–∞–∂–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é
docker-compose exec bot alembic current

# –ø–æ–∫–∞–∂–µ–º –∑–Ω–∞—á–µ–Ω–∏—è enum
docker-compose exec db psql -U saasuser -d saasdb -c "SELECT e.enumlabel FROM pg_type t JOIN pg_enum e ON t.oid=e.enumtypid WHERE t.typname='user_role' ORDER BY e.enumsortorder;"

# –ø—Ä–æ–≤–µ—Ä—å —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
docker-compose exec db psql -U saasuser -d saasdb -c "SELECT role, count(*) FROM users GROUP BY role;"

# –ø—Ä–æ–≥–æ–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –º–æ–¥–µ–ª–µ–π
docker-compose exec bot python scripts/check_models_vs_db.py

# –ø—Ä–æ–≤–µ—Ä–∫–∞ alembic autogenerate (autogen check)
docker-compose exec bot alembic revision --autogenerate -m "autogen_check" || true
# –µ—Å–ª–∏ —Å–æ–∑–¥–∞–ª—Å—è —Ñ–∞–π–ª migrations/versions/*autogen_check*.py ‚Äî CI –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å; —É–¥–∞–ª–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
docker-compose exec bot bash -lc "ls -1 migrations/versions | grep autogen_check || true"
# (–µ—Å–ª–∏ —Ñ–∞–π–ª –ø–æ—è–≤–∏—Ç—Å—è) —É–¥–∞–ª–∏—Ç—å –µ–≥–æ:
docker-compose exec bot bash -lc "rm -f migrations/versions/*autogen_check*.py || true"
```

---

# 4) –¢–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é enum –≤ –∫–æ–¥–µ –∏ –ë–î

–°–æ–∑–¥–∞–π —Ç–µ—Å—Ç `tests/test_enum_sync.py`:

```python
# tests/test_enum_sync.py
import os
from sqlalchemy import create_engine, text
import pytest

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π —Å–≤–æ–π UserRole —Ç–æ—á–Ω–æ –æ—Ç—Ç—É–¥–∞, –≥–¥–µ –æ–Ω –∂–∏–≤—ë—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ
# –ü—Ä–∏–º–µ—Ä:
try:
    from app.utils.enums import UserRole
except Exception:
    from utils.enums import UserRole

@pytest.mark.smoke
def test_user_role_enum_sync():
    db_url = os.environ.get("DATABASE_URL", "postgresql://saasuser:saaspass@db:5432/saasdb")
    # strip async driver suffix if present
    db_sync = db_url.replace("+asyncpg", "").replace("asyncpg+", "")
    engine = create_engine(db_sync)
    with engine.connect() as conn:
        rows = conn.execute(text(
            "SELECT e.enumlabel FROM pg_type t JOIN pg_enum e ON t.oid = e.enumtypid "
            "WHERE t.typname = 'user_role' ORDER BY e.enumsortorder"
        )).fetchall()
        db_roles = [r[0] for r in rows]
    code_roles = [r.value for r in UserRole]
    assert set(db_roles) == set(code_roles), f"DB roles {db_roles} != code roles {code_roles}"
```

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
docker-compose exec bot pytest -q tests/test_enum_sync.py
```

–î–æ–±–∞–≤—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç –≤ –Ω–∞–±–æ—Ä smoke-tests, —á—Ç–æ–±—ã CI –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ.

---

# 5) –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ä–µ–∑—é–º–µ –∫–æ–º–∞–Ω–¥)

1. –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø:

```bash
docker-compose exec -T db pg_dump -U saasuser saasdb > ./backups/saasdb_before_enum.sql
```

2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Ñ–∞–π–ª (—Å–º. –≤—ã—à–µ), –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å.

3. –ü—Ä–æ–≥–Ω–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
docker-compose exec bot alembic upgrade head
```

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è enum:

```bash
docker-compose exec db psql -U saasuser -d saasdb -c "SELECT enumlabel FROM pg_type t JOIN pg_enum e ON t.oid=e.enumtypid WHERE t.typname='user_role' ORDER BY e.enumsortorder;"
```

5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã:

```bash
docker-compose exec db psql -U saasuser -d saasdb -c "SELECT role, COUNT(*) FROM users GROUP BY role;"
```

6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª–∏:

```bash
docker-compose exec bot python scripts/check_models_vs_db.py
```

7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (CI-–ø—Ä–æ–≤–µ—Ä–∫–∞):

```bash
docker-compose exec bot alembic revision --autogenerate -m "autogen_check" || true
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è —Ñ–∞–π–ª autogen_check.py –≤ migrations/versions
```

8. –ü—Ä–æ–≥–Ω–∞—Ç—å smoke-tests (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ enum):

```bash
docker-compose exec bot pytest -q -m smoke
```

–ï—Å–ª–∏ –≤—Å–µ –∑–µ–ª—ë–Ω–æ–µ ‚Äî –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å job `migrations_apply_on_clean_db` –≤ CI.

---

# 6) –ó–∞–º–µ—á–∞–Ω–∏—è, —Ä–∏—Å–∫–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏

* **–ë—ç–∫–∞–ø –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**. –°–æ–∑–¥–∞–π –¥–∞–º–ø –∏/–∏–ª–∏ snapshot volume –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤ staging/production.
* **–ü—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –∫–æ–ª–æ–Ω–æ–∫/—Ç–∞–±–ª–∏—Ü, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö `user_role`**. –í—ã–ø–æ–ª–Ω–∏:

  ```sql
  SELECT n.nspname, c.relname, a.attname
  FROM pg_catalog.pg_attribute a
  JOIN pg_class c ON a.attrelid = c.oid
  JOIN pg_type t ON a.atttypid = t.oid
  JOIN pg_namespace n ON c.relnamespace = n.oid
  WHERE t.typname = 'user_role' AND a.attnum > 0;
  ```

  ‚Äî –µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å, –∏—Ö —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `role_new` –¥–æ–±–∞–≤–ª—è—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π).
* **Downtime**: –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ª–≥–æ–≥–æ –¥–∞—É–Ω—Ç–∞–π–º–∞, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –≤ maintenance window –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.
* **–ï—Å–ª–∏ —É –≤–∞—Å foreign keys / triggers / default values —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–æ—Ç enum ‚Äî** –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–æ–≤–µ—Ä—å –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏—é.
* **–ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π**: –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π —Å—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—É—é —Å–≤–µ—Ä—Ö—É (history preserved).

---

# 7) –û–±–Ω–æ–≤–∏ –∫–æ–¥ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω)

–£–±–µ–¥–∏—Å—å, —á—Ç–æ `UserRole` –≤ –∫–æ–¥–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç:

```python
# app/utils/enums.py
from enum import Enum

class UserRole(str, Enum):
    WORKER = "worker"
    FOREMAN = "foreman"
    MANAGER = "manager"
    ADMIN = "admin"
```

–ö–æ–º–º–∏—Ç–Ω–∏ —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ. –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —ç—Ç–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ —É —Ç–µ–±—è –±—É–¥–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –∫–æ–¥ ‚Üî –ë–î.

---

# 8) –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ CI (–æ—Ç–≤–µ—Ç –Ω–∞ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã—à–µ–æ–ø–∏—Å–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ –∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è:

* `alembic upgrade head` –Ω–∞ —á–∏—Å—Ç–æ–π –ë–î,
* `check_models_vs_db.py` –±–µ–∑ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–µ–π (–∏–≥–Ω–æ—Ä–∏—Ä—É—è alembic\_version),
* `alembic revision --autogenerate` ‚Äî –Ω–µ –¥–∞—ë—Ç diff,
* smoke-tests (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç enum\_sync) –∑–µ–ª—ë–Ω—ã–µ ‚Äî
  —Ç–æ–≥–¥–∞ **–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å CI job migrations\_apply\_on\_clean\_db**.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É:

* 1. —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ–±—è –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º `revision` (–∏ —Å—Ä–∞–∑—É –≤—Å—Ç–∞–≤–∏—Ç—å `down_revision` —Ä–∞–≤–Ω—ã–º —Ç–≤–æ–µ–º—É head),
* 2. –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π smoke-test, –ø–æ–º–µ—Ç–∏—Ç—å –µ–≥–æ `@pytest.mark.smoke` (—è —É–∂–µ –ø—Ä–∏–≤—ë–ª –ø—Ä–∏–º–µ—Ä),
* 3. –¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫).

–°–∫–∞–∂–∏ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
